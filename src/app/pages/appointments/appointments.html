<app-page-header
  title="Appointments"
  subtitle="Manage scheduling and patient bookings">
  <button class="btn btn-primary" (click)="openBookingModal()">
    + New Appointment
  </button>
</app-page-header>

<div class="appointments-container">
  <!-- Calendar Navigation -->
  <div class="calendar-header">
    <div class="date-navigation">
      <button class="nav-btn" (click)="previousDay()"><i class="fa-solid fa-chevron-left"></i></button>
      <h2>{{ formatDate(currentDate) }}</h2>
      <button class="nav-btn" (click)="nextDay()"><i class="fa-solid fa-chevron-right"></i></button>
    </div>
    <div class="view-controls">
      <button class="btn btn-outline" (click)="goToToday()">Today</button>
      <div class="search-inline">
        <i class="fa-solid fa-search"></i>
        <input type="text" [(ngModel)]="searchQuery" placeholder="Search patient, doctor..." (input)="0">
      </div>
      <div class="view-toggle">
        <button [class.active]="viewMode === 'day'" (click)="viewMode = 'day'">Day</button>
        <button [class.active]="viewMode === 'week'" (click)="viewMode = 'week'">Week</button>
      </div>
    </div>
  </div>

  <!-- Day View -->
  <div class="schedule-grid" *ngIf="viewMode === 'day'">
    <div class="time-column">
      <div class="time-slot" *ngFor="let slot of timeSlots">
        <span class="time-label">{{ slot.time }}</span>
      </div>
    </div>

    <div class="appointments-column">
      <div class="slot-row" *ngFor="let slot of timeSlots">
        <div class="slot-content">
          <div class="appointment-card"
               *ngFor="let apt of getAppointmentsForSlot(slot)"
               [style.borderLeftColor]="getStatusColor(apt.status)">
            <div class="apt-header">
              <span class="patient-name">{{ getPatientName(apt.patientId) }}</span>
              <span class="status-badge" [style.background]="getStatusColor(apt.status)">
                {{ apt.status }}
              </span>
            </div>
            <div class="apt-details">
              <span>{{ getDoctorName(apt.doctorId) }}</span>
              <span class="separator">â€¢</span>
              <span>{{ getRoomName(apt.roomId) }}</span>
            </div>
            <div class="apt-actions">
              <ng-container [ngSwitch]="apt.status">
                <!-- Scheduled -->
                <div *ngSwitchCase="'scheduled'" class="action-group">
                  <button class="action-btn check-in" title="Check In" (click)="updateStatus(apt, 'checked-in')">
                    <i class="fa-solid fa-user-check"></i> Check In
                  </button>
                  <button class="action-btn no-show" title="No Show" (click)="updateStatus(apt, 'no-show')">
                    <i class="fa-solid fa-user-slash"></i>
                  </button>
                  <button class="action-btn cancel" title="Cancel" (click)="updateStatus(apt, 'cancelled')">
                    <i class="fa-solid fa-xmark"></i>
                  </button>
                </div>

                <!-- Checked In -->
                <div *ngSwitchCase="'checked-in'" class="action-group">
                  <button class="action-btn start" title="Start Session" (click)="updateStatus(apt, 'in-progress')">
                    <i class="fa-solid fa-play"></i> Start Session
                  </button>
                  <button class="action-btn cancel" title="Cancel" (click)="updateStatus(apt, 'cancelled')">
                    <i class="fa-solid fa-xmark"></i>
                  </button>
                </div>

                <!-- In Progress -->
                <div *ngSwitchCase="'in-progress'" class="action-group">
                  <button class="action-btn complete" title="Complete Treatment" (click)="updateStatus(apt, 'completed')">
                    <i class="fa-solid fa-check-double"></i> Complete
                  </button>
                </div>

                <!-- Completed -->
                <div *ngSwitchCase="'completed'" class="action-group">
                  <span class="status-done"><i class="fa-solid fa-circle-check"></i> Ready for Billing</span>
                </div>

                <!-- Billed -->
                <div *ngSwitchCase="'billed'" class="action-group">
                  <span class="status-done gray"><i class="fa-solid fa-file-invoice-dollar"></i> Billed</span>
                </div>
              </ng-container>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Week View -->
  <div class="week-grid" *ngIf="viewMode === 'week'">
    <div class="week-day" *ngFor="let day of weekDays">
      <div class="week-day-header" [class.today]="isToday(day.date)">
        <span class="day-name">{{ day.label }}</span>
        <span class="day-date">{{ day.date | date:'d MMM' }}</span>
      </div>
      <div class="week-day-appointments">
        <div class="week-apt-card" *ngFor="let apt of getAppointmentsForDate(day.date)"
             [style.borderLeftColor]="getStatusColor(apt.status)">
          <span class="week-apt-time">{{ formatTime(apt.scheduledStart) }}</span>
          <span class="week-apt-patient">{{ getPatientName(apt.patientId) }}</span>
          <span class="status-dot" [style.background]="getStatusColor(apt.status)"></span>
        </div>
        <div class="week-empty" *ngIf="getAppointmentsForDate(day.date).length === 0">
          <span>No appointments</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Booking Modal -->
<app-modal
  [isOpen]="showBookingModal"
  title="Book Appointment"
  maxWidth="700px"
  [showFooter]="false"
  (closed)="closeBookingModal()">

  <!-- Updated Progress Steps (5 Steps) -->
  <div class="booking-steps">
    <div class="step" [class.active]="bookingStep >= 1" [class.completed]="bookingStep > 1">
      <span class="step-number">1</span>
      <span class="step-label">Patient</span>
    </div>
    <div class="step-line" [class.active]="bookingStep > 1"></div>
    <div class="step" [class.active]="bookingStep >= 2" [class.completed]="bookingStep > 2">
      <span class="step-number">2</span>
      <span class="step-label">Services</span>
    </div>
    <div class="step-line" [class.active]="bookingStep > 2"></div>
    <div class="step" [class.active]="bookingStep >= 3" [class.completed]="bookingStep > 3">
      <span class="step-number">3</span>
      <span class="step-label">Group</span>
    </div>
    <div class="step-line" [class.active]="bookingStep > 3"></div>
    <div class="step" [class.active]="bookingStep >= 4" [class.completed]="bookingStep > 4">
      <span class="step-number">4</span>
      <span class="step-label">Schedule</span>
    </div>
    <div class="step-line" [class.active]="bookingStep > 4"></div>
    <div class="step" [class.active]="bookingStep >= 5">
      <span class="step-number">5</span>
      <span class="step-label">Confirm</span>
    </div>
  </div>

  <!-- Step 1: Patient Selection -->
  <div class="step-content" *ngIf="bookingStep === 1">
    <h3>Select or Add Patient</h3>

    <div class="patient-toggle">
      <button [class.active]="!booking.isNewPatient" (click)="booking.isNewPatient = false">
        Existing Patient
      </button>
      <button [class.active]="booking.isNewPatient" (click)="booking.isNewPatient = true">
        New Patient
      </button>
    </div>

    <div *ngIf="!booking.isNewPatient" class="search-section">
      <div class="form-group">
        <label>Search Patient</label>
        <input type="text"
               name="patientSearch"
               [(ngModel)]="booking.patientSearch"
               (input)="searchPatients()"
               placeholder="Search by name or phone...">
      </div>
      <span class="error-text" *ngIf="bookingAttemptedStep1 && !booking.patientId">Please select a patient</span>
      <div class="search-results" *ngIf="filteredPatients.length > 0">
        <div class="result-item"
             *ngFor="let patient of filteredPatients"
             [class.selected]="booking.patientId === patient.id"
             (click)="selectPatient(patient)">
          <div class="patient-avatar">{{ patient.firstName.charAt(0) }}</div>
          <div class="patient-info">
            <span class="name">{{ patient.firstName }} {{ patient.lastName }}</span>
            <span class="phone">{{ patient.phone }}</span>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="booking.isNewPatient" class="new-patient-form">
      <div class="form-row">
        <div class="form-group">
          <label>First Name *</label>
          <input type="text" name="newFirstName" required [(ngModel)]="booking.newPatient.firstName" placeholder="First name" #newFirstName="ngModel">
          <span class="error-text" *ngIf="newFirstName.invalid && (newFirstName.touched || newFirstName.dirty || bookingAttemptedStep1)">First name is required</span>
        </div>
        <div class="form-group">
          <label>Last Name *</label>
          <input type="text" name="newLastName" required [(ngModel)]="booking.newPatient.lastName" placeholder="Last name" #newLastName="ngModel">
          <span class="error-text" *ngIf="newLastName.invalid && (newLastName.touched || newLastName.dirty || bookingAttemptedStep1)">Last name is required</span>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Phone *</label>
          <input type="tel" name="newPhone" required [(ngModel)]="booking.newPatient.phone" placeholder="+20 xxx xxx xxxx" #newPhone="ngModel">
          <span class="error-text" *ngIf="newPhone.invalid && (newPhone.touched || newPhone.dirty || bookingAttemptedStep1)">Phone is required</span>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" name="newEmail" [(ngModel)]="booking.newPatient.email" placeholder="email@example.com">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Date of Birth</label>
          <input type="date" name="newDob" [(ngModel)]="booking.newPatient.dateOfBirth">
        </div>
        <div class="form-group">
          <label>Gender</label>
          <select name="newGender" [(ngModel)]="booking.newPatient.gender">
            <option value="female">Female</option>
            <option value="male">Male</option>
          </select>
        </div>
      </div>
    </div>
  </div>



  <!-- Step 2: Service Selection -->
  <div class="step-content" *ngIf="bookingStep === 2">
    <h3>Select Services</h3>
    <div class="services-grid">
      <div class="service-card"
           *ngFor="let service of services"
           [class.selected]="isServiceSelected(service.id)"
           (click)="toggleService(service.id)">
        <div class="service-check">
           <span *ngIf="isServiceSelected(service.id)"><i class="fa-solid fa-check"></i></span>
        </div>
        <div class="service-info">
          <span class="service-name">{{ service.name }}</span>
          <span class="service-duration">{{ service.duration }} min</span>
        </div>
        <div class="service-price">
          EGP {{ service.pricingModels[0]?.basePrice || 0 }}
        </div>
      </div>
    </div>
    <div class="selection-summary" *ngIf="booking.allServiceIds.length > 0">
      <span>{{ booking.allServiceIds.length }} service(s) selected</span>
      <span>Total duration: {{ getTotalDuration() }} min</span>
    </div>
    <span class="error-text" *ngIf="bookingAttemptedStep2 && booking.allServiceIds.length === 0">Select at least one service</span>
  </div>

  <!-- Step 3: Structure (Grouping) -->
  <div class="step-content" *ngIf="bookingStep === 3">
    <div class="section-header">
       <h3>Review & Group Appointments</h3>
       <p class="text-secondary text-sm">Combine compatible services into a single visit, or schedule them separately.</p>
    </div>

    <div class="segments-list">
        <div class="segment-card" *ngFor="let seg of bookingSegments; let i = index"
             [class.selected]="selectedSegmentIndices.includes(i)"
             [class.merged-bundle]="seg.serviceIds.length > 1">
            <div class="segment-selection">
                <input type="checkbox"
                       [checked]="selectedSegmentIndices.includes(i)"
                       (change)="toggleSegmentSelection(i)"
                       [disabled]="seg.serviceIds.length > 1">
            </div>
            <div class="segment-info">
                <div class="segment-label font-bold">{{ seg.label }}</div>
                <div class="segment-meta text-sm text-muted">
                    <span *ngIf="seg.serviceIds.length > 1">{{ seg.serviceIds.length }} Services &bull; </span>
                    {{ seg.duration }} mins
                </div>
            </div>
            <div class="segment-actions">
                <button class="btn btn-outline btn-xs"
                        *ngIf="seg.serviceIds.length > 1"
                        (click)="splitSegment(i)">
                    Split
                </button>
            </div>
        </div>
    </div>
    <div class="grouping-toolbar" *ngIf="selectedSegmentIndices.length > 1">
        <button class="btn btn-primary btn-sm w-full"
                [disabled]="!canMergeSelected()"
                (click)="mergeSelectedSegments()">
            Merge Selected ({{ selectedSegmentIndices.length }})
        </button>
    </div>
  </div>

  <!-- Step 4: Schedule -->
  <div class="step-content" *ngIf="bookingStep === 4">
    <div class="section-header">
       <div class="header-row" style="display: flex; justify-content: space-between; align-items: center;">
          <h3>Choose Date & Time</h3>
       </div>
       <p *ngIf="bookingSegments.length > 1" class="text-primary font-bold">
          Step {{ currentSegmentIndex + 1 }} of {{ bookingSegments.length }}: Scheduling {{ getCurrentSegment().label }}
       </p>
    </div>

    <div class="date-selector mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
        <input type="date"
               [ngModel]="getCurrentSegment().date"
               (ngModelChange)="updateBookingDate($event)"
               [min]="minDate"
               class="form-input date-input-premium">
    </div>

    <div class="schedule-wizard">
      <div class="slots-container">
        <div class="slots-grid" *ngIf="availableSlots.length > 0; else noSlots">
          <div class="slot-card"
               *ngFor="let slot of availableSlots"
               [class.selected]="getCurrentSegment().time === slot.time"
               (click)="selectSlot(slot)">
            <span class="slot-time">{{ slot.time }}</span>
            <div class="slot-resources">
              <span class="res-badge doc" *ngIf="slot.doctors.length === 1">Dr. {{ slot.doctors[0].name.split(' ').pop() }}</span>
              <span class="res-badge doc" *ngIf="slot.doctors.length > 1">{{ slot.doctors.length }} Docs</span>
              <span class="res-badge room" *ngIf="slot.rooms.length === 1">{{ slot.rooms[0].name }}</span>
            </div>
          </div>
        </div>
        <ng-template #noSlots>
          <div class="empty-state">
            <i class="fa-solid fa-calendar-xmark"></i>
            <p>No available slots found for this date.</p>
          </div>
        </ng-template>
      </div>

      <div class="resource-refinement" *ngIf="getCurrentSegment() && getCurrentSegment()!.time && (selectedSlotDoctors.length > 1 || selectedSlotRooms.length > 1)">
          <div class="form-group" *ngIf="selectedSlotDoctors.length > 1">
             <label>Select Doctor</label>
             <select [(ngModel)]="getCurrentSegment().doctorId">
                <option *ngFor="let doc of selectedSlotDoctors" [value]="doc.id">Dr. {{ doc.name }}</option>
             </select>
          </div>
          <div class="form-group" *ngIf="selectedSlotRooms.length > 1">
             <label>Select Room</label>
             <select [(ngModel)]="getCurrentSegment().roomId">
                <option *ngFor="let room of selectedSlotRooms" [value]="room.id">{{ room.name }}</option>
             </select>
          </div>
      </div>

      <div class="form-group mt-3" *ngIf="currentSegmentIndex === bookingSegments.length - 1">
        <label>Notes</label>
        <textarea [(ngModel)]="booking.notes" rows="2" placeholder="Optional notes..."></textarea>
      </div>
    </div>
    <span class="error-text" *ngIf="bookingAttemptedStep4 && !isCurrentSegmentComplete()">Select date, time, doctor, and room</span>
  </div>

  <!-- Step 5: Confirm & Pay -->
  <div class="step-content" *ngIf="bookingStep === 5">
    <h3>Review & Payment</h3>

    <div class="review-grid">
       <!-- Invoice Items -->
       <div class="invoice-summary">
          <h4>Booking Summary</h4>
          <div class="summary-item" *ngFor="let item of bookingSummary.items">
             <div class="item-name">
                <span class="font-bold">{{ item.serviceName }}</span>
                <span class="text-xs text-muted block" *ngIf="item.creditAvailable > 0">
                   {{ item.creditAvailable }} units available
                </span>
             </div>
             <div class="item-actions">
                <div class="credit-toggle" *ngIf="item.creditAvailable > 0">
                   <label class="switch">
                      <input type="checkbox"
                             [checked]="item.isCreditCovered"
                             (change)="toggleCreditUsage(item.serviceId)">
                      <span class="slider round"></span>
                   </label>
                   <span class="text-sm ml-2" [class.text-success]="item.isCreditCovered">Use Credit</span>
                </div>
             </div>
             <div class="item-price">
                 <span *ngIf="!item.isCreditCovered">{{ item.price | number }} EGP</span>
                 <span *ngIf="item.isCreditCovered" class="text-success font-bold">0 EGP (Credit)</span>
             </div>
          </div>

          <!-- Offers Section inside Invoice -->
          <div class="offers-section mt-4" *ngIf="bookingSummary.items.length > 0">
             <div class="offers-trigger" (click)="bookingStep = 5"> <!-- TODO: Toggle Offers Logic/Modal? Or integrated? -->
                <!-- Simplified: Just show if offers are available or currently applied -->
                <div *ngIf="applicableOffers.length > 0">
                   <label class="block mb-2">Available Offers</label>
                   <select [(ngModel)]="booking.offerId" (change)="calculateBookingSummary()">
                      <option [ngValue]="undefined">No Offer Selected</option>
                      <option *ngFor="let app of applicableOffers" [value]="app.offer.id">
                         {{ app.offer.name }} (-{{ app.discountAmount }} EGP)
                      </option>
                   </select>
                </div>
             </div>
          </div>

          <div class="invoice-divider"></div>
          
          <div class="invoice-totals">
             <div class="total-row">
                <span>Subtotal</span>
                <span>{{ bookingSummary.totalAmount | number }} EGP</span>
             </div>
             <div class="total-row" *ngIf="bookingSummary.discountAmount > 0">
                <span>Discount</span>
                <span class="text-success">-{{ bookingSummary.discountAmount | number }} EGP</span>
             </div>
              <div class="total-row final">
                <span>Total to Pay</span>
                <span>{{ bookingSummary.finalAmount | number }} EGP</span>
             </div>
          </div>
       </div>

       <!-- Schedule Summary (Compact) -->
       <div class="schedule-summary-compact">
          <h4>Schedule</h4>
          <div class="compact-segment" *ngFor="let seg of bookingSegments">
             <div class="compact-date">
                <span class="day">{{ seg.date | date:'d' }}</span>
                <span class="month">{{ seg.date | date:'MMM' }}</span>
             </div>
             <div class="compact-details">
                <span class="time">{{ seg.time }}</span>
                <span class="doc">{{ getDoctorName(seg.doctorId) }}</span>
                <span class="room text-muted text-xs">{{ getRoomName(seg.roomId) }}</span>
             </div>
          </div>
       </div>
    </div>
  </div>

  <!-- Navigation Buttons -->
  <div class="modal-navigation">
    <button class="btn btn-outline" *ngIf="bookingStep > 1" (click)="prevStep()">
      <i class="fa-solid fa-arrow-left"></i> Back
    </button>
    <div class="spacer"></div>
    <button class="btn btn-outline" (click)="closeBookingModal()">Cancel</button>
    <button class="btn btn-primary"
            *ngIf="bookingStep < 5"
            (click)="nextStep()">
      <span *ngIf="bookingStep === 4 && currentSegmentIndex < bookingSegments.length - 1">Next Appointment</span>
      <span *ngIf="!(bookingStep === 4 && currentSegmentIndex < bookingSegments.length - 1)">Next</span>
      <i class="fa-solid fa-arrow-right"></i>
    </button>
    <button class="btn btn-primary"
            *ngIf="bookingStep === 5"
            (click)="confirmBooking()">
      Confirm Booking
    </button>
  </div>
</app-modal>

<!-- Reschedule Modal -->
<app-modal
  [isOpen]="showRescheduleModal"
  title="Reschedule Appointment"
  maxWidth="550px"
  [showFooter]="false"
  (closed)="closeRescheduleModal()">

  <div class="reschedule-content">
    <!-- Appointment Summary -->
    <div class="reschedule-summary">
      <div class="summary-row">
        <span class="label"><i class="fa-solid fa-user"></i> Patient:</span>
        <span class="value">{{ getReschedulePatientName() }}</span>
      </div>
      <div class="summary-row">
        <span class="label"><i class="fa-solid fa-syringe"></i> Services:</span>
        <span class="value">{{ getRescheduleServices() }}</span>
      </div>
    </div>

    <!-- Date Selection -->
    <div class="form-group">
      <label>Select New Date</label>
      <input type="date"
             [(ngModel)]="rescheduleDate"
             [min]="minDate"
             (change)="onRescheduleDateChange()">
      <span class="error-text" *ngIf="rescheduleAttempted && !rescheduleDate">Date is required</span>
    </div>

    <!-- Time Slots -->
    <div class="form-group" *ngIf="rescheduleDate">
      <label>Available Time Slots</label>
      <div class="time-slots-grid" *ngIf="rescheduleAvailableSlots.length > 0">
        <button *ngFor="let slot of rescheduleAvailableSlots"
                class="slot-btn"
                [class.selected]="rescheduleTime === slot.time"
                (click)="selectRescheduleSlot(slot)">
          {{ slot.time }}
        </button>
      </div>
      <div class="no-slots" *ngIf="rescheduleAvailableSlots.length === 0">
        <i class="fa-solid fa-calendar-xmark"></i>
        No available slots for this date
      </div>
      <span class="error-text" *ngIf="rescheduleAttempted && !rescheduleTime">Time is required</span>
    </div>

    <!-- Doctor & Room Selection -->
    <div class="form-row" *ngIf="rescheduleTime">
      <div class="form-group">
        <label>Doctor</label>
        <select [(ngModel)]="rescheduleDoctorId">
          <option value="">Select Doctor</option>
          <option *ngFor="let doc of rescheduleSelectedDoctors" [value]="doc.id">
            {{ doc.name }}
          </option>
        </select>
        <span class="error-text" *ngIf="rescheduleAttempted && !rescheduleDoctorId">Doctor is required</span>
      </div>
      <div class="form-group">
        <label>Room</label>
        <select [(ngModel)]="rescheduleRoomId">
          <option value="">Select Room</option>
          <option *ngFor="let room of rescheduleSelectedRooms" [value]="room.id">
            {{ room.name }}
          </option>
        </select>
        <span class="error-text" *ngIf="rescheduleAttempted && !rescheduleRoomId">Room is required</span>
      </div>
    </div>

    <!-- Actions -->
    <div class="modal-actions">
      <button class="btn btn-outline" (click)="closeRescheduleModal()">Cancel</button>
      <button class="btn btn-primary"
              [disabled]="!canConfirmReschedule()"
              (click)="confirmReschedule()">
        <i class="fa-solid fa-calendar-check"></i> Confirm Reschedule
      </button>
    </div>
  </div>
</app-modal>
