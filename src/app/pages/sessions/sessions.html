<app-page-header
  title="Active Sessions"
  subtitle="Monitor and manage ongoing treatment sessions">
</app-page-header>

<!-- Stats -->
<div class="stats-row">
  <app-stat-card
    icon="fa-solid fa-play-circle"
    iconBg="rgba(139, 92, 246, 0.1)"
    [value]="activeSessions.length"
    label="Active Sessions">
  </app-stat-card>
  <app-stat-card
    icon="fa-solid fa-user-clock"
    iconBg="rgba(245, 158, 11, 0.1)"
    [value]="checkedInAppointments.length"
    label="Waiting (Checked-In)">
  </app-stat-card>
</div>

<!-- Active Sessions Grid -->
<div class="section-card">
  <div class="section-header">
    <h3><i class="fa-solid fa-bolt"></i> Active Sessions</h3>
  </div>

  <div class="sessions-grid" *ngIf="activeSessions.length > 0">
    <div class="session-card" *ngFor="let session of activeSessions">
      <div class="session-header">
        <div class="patient-avatar">
          {{ (session.patient.firstName || '').charAt(0) }}{{ (session.patient.lastName || '').charAt(0) }}
        </div>
        <div class="patient-info">
          <span class="name">{{ session.patient.firstName }} {{ session.patient.lastName }}</span>
          <span class="room">{{ session.room.name }}</span>
        </div>
        <div class="elapsed-time" [class.warning]="session.elapsedMinutes > 60">
          <i class="fa-solid fa-clock"></i>
          {{ formatElapsed(session.elapsedMinutes) }}
        </div>
      </div>

      <div class="session-services">
        <span class="service-tag" *ngFor="let svc of session.services">
          {{ svc.name }}
        </span>
      </div>

      <div class="session-meta">
        <span><i class="fa-solid fa-user-doctor"></i> {{ session.doctor.name }}</span>
        <span><i class="fa-solid fa-clock"></i> Started: {{ formatTime(session.startTime) }}</span>
      </div>

      <div class="session-actions">
        <button class="btn btn-outline btn-sm" (click)="openSessionModal(session)">
          <i class="fa-solid fa-clipboard"></i> Notes
        </button>
        <button class="btn btn-primary btn-sm" (click)="quickEndSession(session)">
          <i class="fa-solid fa-check"></i> End Session
        </button>
      </div>
    </div>
  </div>

  <div class="empty-state" *ngIf="activeSessions.length === 0">
    <i class="fa-solid fa-hourglass-empty"></i>
    <p>No active sessions</p>
  </div>
</div>

<!-- Waiting Queue -->
<div class="section-card">
  <div class="section-header">
    <h3><i class="fa-solid fa-users-clock"></i> Waiting Queue (Checked-In)</h3>
  </div>

  <div class="waiting-list" *ngIf="checkedInAppointments.length > 0">
    <div class="waiting-item" *ngFor="let apt of checkedInAppointments">
      <div class="waiting-info">
        <span class="patient-name">{{ getPatientName(apt.patientId) }}</span>
        <span class="services">{{ getServiceNames(apt).join(', ') }}</span>
      </div>
      <div class="waiting-meta">
        <span class="doctor">{{ getDoctorName(apt.doctorId) }}</span>
        <span class="room">{{ getRoomName(apt.roomId) }}</span>
      </div>
      <button class="btn btn-primary btn-sm" (click)="startSession(apt)">
        <i class="fa-solid fa-play"></i> Start
      </button>
    </div>
  </div>

  <div class="empty-state" *ngIf="checkedInAppointments.length === 0">
    <p>No patients waiting</p>
  </div>
</div>

<!-- Session Notes Modal -->
<app-modal
  [isOpen]="showSessionModal"
  title="Session Notes"
  (closed)="closeSessionModal()"
  (confirmed)="saveNotesAndEndSession(selectedSession!)"
  confirmText="Continue to End Session">

  <div class="session-modal-content" *ngIf="selectedSession">
    <div class="patient-summary">
      <strong>{{ selectedSession.patient.firstName }} {{ selectedSession.patient.lastName }}</strong>
      <span>{{ selectedSession.room.name }} • {{ formatElapsed(selectedSession.elapsedMinutes) }}</span>
    </div>

    <div class="form-group">
      <label>Clinical Notes</label>
      <textarea
        [(ngModel)]="sessionNotes"
        rows="4"
        placeholder="Enter session notes, observations, recommendations...">
      </textarea>
    </div>

    <p class="hint" style="margin-top: 1rem;">
      <i class="fa-solid fa-info-circle"></i>
      Click "Continue to End Session" to track resources, credits, and consumables used.
    </p>
  </div>
</app-modal>

<!-- End Session Resource Tracking Modal -->
<app-modal
  [isOpen]="showEndSessionModal"
  title="End Session"
  (closed)="closeEndSessionModal()"
  (confirmed)="confirmEndSession()"
  confirmText="Finish & Bill">

  <div class="session-modal-content" *ngIf="selectedSession">
    <div class="patient-summary">
      <strong>{{ selectedSession.patient.firstName }} {{ selectedSession.patient.lastName }}</strong>
      <span>{{ selectedSession.room.name }} • {{ formatElapsed(selectedSession.elapsedMinutes) }}</span>
    </div>

    <!-- Credits Used -->
    <div class="form-group">
      <label>Credits Used</label>
      <p class="hint">Adjust actual usage vs reserved credits</p>
      <div class="credits-table" *ngIf="endSessionCredits.length > 0">
        <div class="credits-row header">
          <span>Service</span>
          <span>Allocated</span>
          <span>Actual Used</span>
        </div>
        <div class="credits-row" *ngFor="let credit of endSessionCredits">
          <span>{{ credit.serviceName }}</span>
          <span>{{ credit.allocated }} {{ credit.unitType }}</span>
          <span>
            <input
              type="number"
              min="0"
              [(ngModel)]="credit.actual" />
          </span>
        </div>
      </div>
      <div class="empty-state" *ngIf="endSessionCredits.length === 0">
        <p>No credits were reserved for this session.</p>
      </div>

      <div class="overage-warning" *ngIf="getCreditsOverage().length > 0">
        <strong>Overage detected:</strong>
        <ul>
          <li *ngFor="let over of getCreditsOverage()">
            {{ over.serviceName }}: +{{ over.overage }} units
          </li>
        </ul>
      </div>
      <span class="error-text" *ngIf="endSessionAttempted && hasInvalidCreditsUsage()">Credits used must be 0 or more</span>
    </div>

    <!-- Device Usage -->
    <div class="form-group">
      <label>Device Usage</label>
      <p class="hint">Record device counters used during the session</p>
      <div class="device-list" *ngIf="endSessionDeviceUsage.length > 0">
        <div class="device-row" *ngFor="let device of endSessionDeviceUsage">
          <span>{{ device.name }}</span>
          <input type="number" min="0" [(ngModel)]="device.unitsUsed" />
        </div>
      </div>
      <div class="empty-state" *ngIf="endSessionDeviceUsage.length === 0">
        <p>No devices assigned to this room.</p>
      </div>
      <span class="error-text" *ngIf="endSessionAttempted && hasInvalidDeviceUsage()">Device usage must be 0 or more</span>
    </div>

    <!-- Laser Settings -->
    <div class="form-group" *ngIf="isLaserSession()">
      <label>Laser Settings</label>
      <p class="hint">Select the wavelength and power used</p>
      <div class="laser-settings-row">
        <select [(ngModel)]="endSessionLaserSettings.waveType">
          <option value="Alexandrite">Alexandrite</option>
          <option value="Nd:YAG">Nd:YAG</option>
        </select>
        <input type="number" [(ngModel)]="endSessionLaserSettings.power" placeholder="Power" min="0" />
        <span class="unit-label">mJ</span>
      </div>
      <span class="error-text" *ngIf="endSessionAttempted && hasInvalidLaserSettings()">Laser power must be greater than 0</span>
    </div>

    <!-- Consumables -->
    <div class="form-group">
      <label>Consumables</label>
      <p class="hint">Add consumables used during the session</p>

      <div class="consumable-picker">
        <select #consumableSelect (change)="addConsumable(consumableSelect.value); consumableSelect.value=''">
          <option value="">Select item</option>
          <option *ngFor="let item of inventory" [value]="item.id">
            {{ item.name }} (Available: {{ item.quantity }})
          </option>
        </select>
      </div>

      <div class="consumable-list" *ngIf="endSessionConsumables.length > 0">
        <div class="consumable-row" *ngFor="let item of endSessionConsumables; let i = index">
          <span>{{ item.name }}</span>
          <input type="number" min="1" [(ngModel)]="item.quantity" />
          <button class="btn btn-outline btn-sm" (click)="removeConsumable(i)">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
      </div>
      <span class="error-text" *ngIf="endSessionAttempted && hasInvalidConsumables()">Consumable quantities must be at least 1</span>
    </div>

    <!-- Extra Charges -->
    <div class="form-group">
      <label>Extra Charges</label>
      <p class="hint">Add any additional charges (overage, materials, etc.)</p>
      <div class="extra-charges" *ngIf="extraCharges.length > 0">
        <div class="extra-charge-row" *ngFor="let charge of extraCharges; let i = index">
          <input
            type="text"
            placeholder="Description"
            [(ngModel)]="charge.description" />
          <input
            type="number"
            min="0"
            placeholder="Amount"
            [(ngModel)]="charge.amount" />
          <button class="btn btn-outline btn-sm" (click)="removeExtraCharge(i)">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
      </div>
      <button class="btn btn-outline btn-sm" (click)="addExtraCharge()">
        <i class="fa-solid fa-plus"></i> Add Charge
      </button>
      <span class="error-text" *ngIf="endSessionAttempted && hasInvalidExtraCharges()">Extra charges require a description and non-negative amount</span>
    </div>

    <!-- Photos -->
    <div class="form-group">
      <label>Session Photos</label>
      <p class="hint">Upload before/after photos for treatment documentation</p>

      <div class="photo-upload-section">
        <div class="photo-category">
          <h4>Before Photos</h4>
          <div class="photo-gallery">
            <div class="photo-item" *ngFor="let photo of beforePhotos; let i = index">
              <img [src]="photo" alt="Before photo">
              <button class="photo-remove" (click)="removePhoto('before', i)">
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
            <label class="photo-add" [class.disabled]="uploadingPhoto">
              <input
                type="file"
                accept="image/*"
                (change)="uploadPhoto($event, 'before')"
                [disabled]="uploadingPhoto" />
              <i class="fa-solid fa-plus"></i>
              <span>Add Photo</span>
            </label>
          </div>
        </div>

        <div class="photo-category">
          <h4>After Photos</h4>
          <div class="photo-gallery">
            <div class="photo-item" *ngFor="let photo of afterPhotos; let i = index">
              <img [src]="photo" alt="After photo">
              <button class="photo-remove" (click)="removePhoto('after', i)">
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
            <label class="photo-add" [class.disabled]="uploadingPhoto">
              <input
                type="file"
                accept="image/*"
                (change)="uploadPhoto($event, 'after')"
                [disabled]="uploadingPhoto" />
              <i class="fa-solid fa-plus"></i>
              <span>Add Photo</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Notes -->
    <div class="form-group">
      <label>Clinical Notes</label>
      <textarea
        [(ngModel)]="sessionNotes"
        rows="4"
        placeholder="Enter session notes, observations, recommendations...">
      </textarea>
    </div>
  </div>
</app-modal>
