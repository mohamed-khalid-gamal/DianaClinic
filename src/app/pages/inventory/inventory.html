<app-page-header
  title="Inventory & Pharmacy"
  subtitle="Track stock levels, expiry dates, and manage products">
  <div class="header-actions">
    <button class="btn btn-outline" (click)="openCategoryModal()">
      <i class="fa-solid fa-tags"></i> Manage Categories
    </button>
    <button class="btn btn-primary" (click)="openAddModal()">
      + Add Item
    </button>
  </div>
</app-page-header>

<!-- Stats Row -->
<div class="stats-row">
  <app-stat-card
    icon="fa-solid fa-boxes-stacked"
    iconBg="rgba(14, 116, 144, 0.1)"
    [value]="getTotalItems()"
    label="Total Products">
  </app-stat-card>

  <app-stat-card
    icon="fa-solid fa-triangle-exclamation"
    iconBg="rgba(245, 158, 11, 0.1)"
    [value]="getLowStockCount()"
    label="Low Stock Items"
    [clickable]="true"
    (cardClick)="activeFilter = 'low'">
  </app-stat-card>

  <app-stat-card
    icon="fa-solid fa-calendar-xmark"
    iconBg="rgba(239, 68, 68, 0.1)"
    [value]="getExpiringCount()"
    label="Expiring Soon"
    [clickable]="true"
    (cardClick)="activeFilter = 'expiring'">
  </app-stat-card>

  <app-stat-card
    icon="fa-solid fa-coins"
    iconBg="rgba(16, 185, 129, 0.1)"
    [value]="'EGP ' + getTotalValue().toLocaleString()"
    label="Inventory Value">
  </app-stat-card>
</div>

<!-- Filter Tabs -->
<div class="filter-tabs">
  <button [class.active]="activeFilter === 'all'" (click)="activeFilter = 'all'">
    All Items
  </button>
  <button *ngFor="let cat of categories"
          [class.active]="activeFilter === cat.id"
          (click)="activeFilter = cat.id">
    {{ cat.name }}
  </button>
  <button [class.active]="activeFilter === 'low'" (click)="activeFilter = 'low'">
    Low Stock
  </button>
  <button [class.active]="activeFilter === 'expiring'" (click)="activeFilter = 'expiring'">
    Expiring Soon
  </button>
</div>

<app-data-table
  [data]="filteredItems"
  [columns]="columns"
  (edit)="openEditModal($event)"
  (delete)="deleteItem($event)">
</app-data-table>

<app-modal
  [isOpen]="showModal"
  [title]="isEditMode ? 'Edit Item' : 'Add New Item'"
  maxWidth="700px"
  (closed)="closeModal()"
  (confirmed)="saveItem(itemFormRef)">

  <form #itemFormRef="ngForm" class="form-grid">
    <div class="form-group">
      <label>Product Name *</label>
      <input type="text" name="name" required [(ngModel)]="itemForm.name" placeholder="Product name" #itemName="ngModel">
      <span class="error-text" *ngIf="itemName.invalid && (itemName.touched || itemName.dirty)">Product name is required</span>
    </div>

    <div class="form-group">
      <label>SKU *</label>
      <input type="text" name="sku" required [(ngModel)]="itemForm.sku" placeholder="e.g., HA-001" #itemSku="ngModel">
      <span class="error-text" *ngIf="itemSku.invalid && (itemSku.touched || itemSku.dirty)">SKU is required</span>
    </div>

    <div class="form-group">
      <label>Category *</label>
      <select name="category" required [(ngModel)]="itemForm.category" #itemCategory="ngModel">
        <option value="">Select category</option>
        <option *ngFor="let cat of categories" [value]="cat.id">{{ cat.name }}</option>
      </select>
      <span class="error-text" *ngIf="itemCategory.invalid && (itemCategory.touched || itemCategory.dirty)">Category is required</span>
    </div>

    <div class="form-group">
      <label>Unit</label>
      <select name="unit" [(ngModel)]="itemForm.unit">
        <option value="piece">Piece</option>
        <option value="vial">Vial</option>
        <option value="bottle">Bottle</option>
        <option value="tube">Tube</option>
        <option value="box">Box</option>
        <option value="pair">Pair</option>
      </select>
    </div>

    <div class="form-group">
      <label>Quantity *</label>
      <input type="number" name="quantity" required [(ngModel)]="itemForm.quantity" min="0" #itemQuantity="ngModel">
      <span class="error-text" *ngIf="itemQuantity.invalid && (itemQuantity.touched || itemQuantity.dirty)">Quantity is required</span>
    </div>

    <div class="form-group">
      <label>Reorder Threshold</label>
      <input type="number" name="reorderThreshold" [(ngModel)]="itemForm.reorderThreshold" min="0">
    </div>

    <div class="form-group">
      <label>Cost Price (EGP)</label>
      <input type="number" name="costPrice" [(ngModel)]="itemForm.costPrice" min="0" step="0.01">
    </div>

    <div class="form-group">
      <label>Selling Price (EGP)</label>
      <input type="number" name="sellingPrice" [(ngModel)]="itemForm.sellingPrice" min="0" step="0.01">
    </div>

    <div class="form-group">
      <label>Expiry Date</label>
      <input type="date" name="expiryDate" [(ngModel)]="itemForm.expiryDate">
    </div>

    <div class="form-group">
      <label>Batch Number</label>
      <input type="text" name="batchNumber" [(ngModel)]="itemForm.batchNumber" placeholder="e.g., B2024-001">
    </div>

    <div class="form-group">
      <label>Supplier</label>
      <input type="text" name="supplier" [(ngModel)]="itemForm.supplier" placeholder="Supplier name">
    </div>

    <div class="form-group">
      <label>Storage Location</label>
      <input type="text" name="location" [(ngModel)]="itemForm.location" placeholder="e.g., Cabinet A">
    </div>
  </form>
</app-modal>

<!-- Category Management Modal -->
<app-modal
  [isOpen]="showCategoryModal"
  title="Manage Categories"
  maxWidth="550px"
  (closed)="closeCategoryModal()"
  [showFooter]="false">

  <div class="category-manager">
    <div class="category-add-form">
      <input type="text" [(ngModel)]="newCategoryName" placeholder="New category name..." class="category-input">
      <button class="btn btn-primary btn-sm" (click)="addNewCategory()" [disabled]="!newCategoryName.trim()">
        <i class="fa-solid fa-plus"></i> Add
      </button>
    </div>

    <div class="category-list" *ngIf="categories.length; else noCats">
      <div class="category-item" *ngFor="let cat of categories">
        <div class="category-info" *ngIf="editingCategoryId !== cat.id">
          <span class="cat-name">{{ cat.name }}</span>
          <span class="cat-count">{{ getItemCountForCategory(cat.id) }} items</span>
        </div>
        <div class="category-edit" *ngIf="editingCategoryId === cat.id">
          <input type="text" [(ngModel)]="editingCategoryName" class="category-input">
        </div>
        <div class="category-actions">
          <button *ngIf="editingCategoryId !== cat.id" class="btn btn-outline btn-sm" (click)="startEditCategory(cat)">
            <i class="fa-solid fa-pen"></i>
          </button>
          <button *ngIf="editingCategoryId === cat.id" class="btn btn-primary btn-sm" (click)="saveCategory(cat)">
            <i class="fa-solid fa-check"></i>
          </button>
          <button *ngIf="editingCategoryId === cat.id" class="btn btn-outline btn-sm" (click)="cancelEditCategory()">
            <i class="fa-solid fa-xmark"></i>
          </button>
          <button *ngIf="editingCategoryId !== cat.id" class="btn btn-outline btn-sm btn-danger" (click)="deleteCategory(cat)" [disabled]="getItemCountForCategory(cat.id) > 0">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
      </div>
    </div>
    <ng-template #noCats>
      <div class="empty-state"><p>No categories yet. Add one above.</p></div>
    </ng-template>
  </div>
</app-modal>
